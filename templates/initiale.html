<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Initiale</title>
  <link rel="preload" as="image" href="{{ url_for('static', filename='img/weather_bets_intro.png') }}">
  <style>
    :root{
      --bg:#0a0f1a;
      --txt:#9fd0ff;
      --halo:0 0 16px rgba(159,208,255,.55), 0 0 32px rgba(70,140,255,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);}

    .stage{
      position:relative;
      min-height:100vh;
      display:grid;
      place-items:center;
      overflow:hidden;
    }

    .slide{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      opacity:0;
      transition:opacity 1s ease;
    }
    .slide.show{ opacity:1; }

    .block{
      max-width: 920px;
      text-align:center;
      padding: 0 24px;
    }
    .line{
      font: 700 28px/1.35 var(--mono);
      letter-spacing:.3px;
      text-shadow: var(--halo);
      white-space:pre-wrap;
    }

    .cursor{
      display:inline-block;
      width:.6ch;
      margin-left:2px;
      animation: blink 1s steps(1,end) infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    .splash-img{
      max-width: min(78vw, 780px);
      height:auto;
      display:block;
      filter: drop-shadow(0 0 24px rgba(70,140,255,.35));
    }

    @media (max-width:640px){
      .line{ font-size:22px; }
    }
    @media (prefers-reduced-motion: reduce){
      .slide{ transition:none; }
    }
  </style>
</head>
<body>
  <main class="stage">
    <!-- Étape 1 : message 1 -->
    <section id="step1" class="slide">
      <div class="block">
        <div id="l1" class="line"></div>
      </div>
    </section>

    <!-- Étape 2 : message 2 -->
    <section id="step2" class="slide">
      <div class="block">
        <div id="l2" class="line"></div>
      </div>
    </section>

    <!-- Étape 3 : image -->
    <section id="step3" class="slide" aria-hidden="true">
      <img class="splash-img" src="{{ url_for('static', filename='img/weather_bets_intro.png') }}" alt="Transition">
    </section>
  </main>

  <!-- Audio préchargé -->
  <audio id="audioStep3" src="{{ url_for('static', filename='audio/initial.mp3') }}" preload="auto"></audio>

  <script>
  (function(){
    const USERNAME = {{ (current_user.username|tojson) if current_user.is_authenticated else "'explorateur'" }};
    const L1 = `Bienvenue dans les cieux ${USERNAME}`;
    const L2 = `Dans un monde où tout devient prévisible, il reste…`;

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const line1 = document.getElementById('l1');
    const line2 = document.getElementById('l2');
    const audioStep3 = document.getElementById('audioStep3');

    const TYPE_MS = 15;
    const HOLD1  = 3500;
    const HOLD2  = 3000;
    const HOLD3  = 3000;
    const FADE   = 1000;

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function typeInto(el, text){
      return new Promise(resolve=>{
        el.textContent = '';
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        cursor.textContent = '▍';
        el.appendChild(cursor);

        let i = 0;
        (function tick(){
          if (i < text.length){
            cursor.insertAdjacentText('beforebegin', text[i++]);
            setTimeout(tick, TYPE_MS);
          } else {
            resolve();
          }
        })();
      });
    }

    async function fadeIn(slide){ slide.classList.add('show'); await sleep(FADE); }
    async function fadeOut(slide){ slide.classList.remove('show'); await sleep(FADE); }

    async function run(){
      // Étape 1
      await fadeIn(step1);
      await typeInto(line1, L1);
      await sleep(HOLD1);
      await fadeOut(step1);

      // Étape 2
      await fadeIn(step2);
      await typeInto(line2, L2);
      await sleep(HOLD2);
      await fadeOut(step2);

      // Étape 3 (image)
      await fadeIn(step3);

      // Jouer le son
      audioStep3.currentTime = 0;
      audioStep3.play().catch(e => console.warn("Impossible de jouer le son automatiquement", e));

      await sleep(HOLD3);
      await fadeOut(step3);

      // Redirection finale
      window.location.assign('{{ url_for("cabine_page") }}?fresh=1');
    }

    const prefersReduced = window.matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReduced){
      step1.classList.add('show');
      line1.textContent = L1;
      setTimeout(()=> window.location.assign('{{ url_for("cabine_page") }}?fresh=1'), 1000);
    } else {
      run();
    }
  })();
  </script>
</body>
</html>