<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Initiale</title>

  <!-- Précharge l’image finale -->
  <link rel="preload" href="{{ url_for('static', filename='img/intro3.png') }}" as="image">

  <style>
    :root{
      --txt:#8cc9ff;         /* bleu clair */
      --glow: rgba(140,201,255,.45);
      --bg:#000;
      --fade-ms: 1000;
    }
    html,body{
      margin:0; height:100%; background:var(--bg); color:var(--txt);
    }
    .stage{
      position:relative; width:100%; height:100vh;
      display:grid; place-items:center; overflow:hidden;
    }

    /* Bloc qui apparaît/disparaît en fondu */
    .fade{
      opacity:0; transition:opacity var(--fade-ms)ms ease;
      will-change:opacity, filter;
      filter: drop-shadow(0 0 18px var(--glow));
    }
    .fade.show{ opacity:1; }

    /* Style "code" + halo */
    .code{
      font: 600 18px/1.5 "SFMono-Regular", ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
      max-width:min(86vw, 900px);
      white-space:pre-wrap;
      text-align:left;
      padding:24px 28px;
      border-radius:14px;
      background: radial-gradient(1200px 600px at 50% 10%, rgba(140,201,255,.06), transparent 60%);
      text-shadow:
        0 0 12px var(--glow),
        0 0 28px rgba(140,201,255,.25),
        0 0 56px rgba(140,201,255,.12);
      letter-spacing:.2px;
      box-shadow: inset 0 0 0 1px rgba(140,201,255,.15);
    }

    /* Curseur type terminal */
    .caret::after{
      content:"▌";
      margin-left:4px;
      animation: blink 1s steps(2, start) infinite;
    }
    @keyframes blink{ 50% { opacity:0; } }

    /* Logo final */
    .logo{
      max-width:min(62vmin, 560px);
      width:100%; height:auto; display:block;
      filter: drop-shadow(0 0 22px var(--glow));
    }

    /* Bouton "Passer" */
    .skip{
      position:fixed; right:14px; bottom:12px;
      color:var(--txt); text-decoration:none; opacity:.65;
      font:14px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .skip:hover{ opacity:1; text-decoration:underline; }
  </style>
</head>
<body>
  <div class="stage">
    <!-- Les 2 messages tapés -->
    <pre id="line" class="code fade caret" aria-live="polite"></pre>
    <!-- L’image finale -->
    <img id="logo" class="logo fade" src="{{ url_for('static', filename='img/intro3.png') }}" alt="Intro">
  </div>

  <a class="skip" href="{{ url_for('cabine_page') }}">Passer</a>

  <script>
    // --- Config séquence ---
    const nextURL = "{{ url_for('cabine_page') }}";
    const USERNAME = "{{ (current_user.username if current_user.is_authenticated else 'Anonyme')|e }}";

    const M1 = `Bienvenue dans les cieux >${USERNAME}<`;
    const M2 = `Dans un monde où tout devient prévisible, il reste...`;

    const HOLD_MS = 4000;   // durée plein écran (texte ou image)
    const TYPE_MS = 26;     // vitesse de frappe (ms par caractère)
    const FADE_MS = 1000;   // doit matcher --fade-ms en CSS

    const $line = document.getElementById('line');
    const $logo = document.getElementById('logo');

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    async function typeInto(el, text){
      el.textContent = "";
      for (let i = 0; i < text.length; i++){
        el.textContent += text[i];
        await sleep(TYPE_MS);
      }
    }
    async function fadeIn(el){ el.classList.add('show'); await sleep(FADE_MS); }
    async function fadeOut(el){ el.classList.remove('show'); await sleep(FADE_MS + 100); }

    async function run(){
      // Message 1
      await fadeIn($line);
      await typeInto($line, M1);
      await sleep(HOLD_MS);
      await fadeOut($line);

      // Message 2
      await fadeIn($line);
      await typeInto($line, M2);
      await sleep(HOLD_MS);
      await fadeOut($line);

      // Image
      await fadeIn($logo);
      await sleep(HOLD_MS);
      await fadeOut($logo);

      // Redirection Cabine
      window.location.assign(nextURL);
    }

    // Démarre quand la page est prête (et filet de sécu)
    if (document.readyState === 'complete') run();
    else window.addEventListener('load', run);
    setTimeout(()=>{ if (document.readyState!=='complete') run(); }, 3000);
  </script>
</body>
</html>
