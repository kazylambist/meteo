<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Initiale</title>
  <style>
    :root{
      --bg:#0a0f1a;
      --txt:#9fd0ff;         /* bleu clair */
      --halo:0 0 16px rgba(159,208,255,.55), 0 0 32px rgba(70,140,255,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);}
    .stage{
      min-height:100%;
      display:grid;
      place-items:center;
      padding:24px;
    }
    /* pas de cadre/contour : juste le texte au centre */
    .block{
      max-width: 920px;
      text-align:center;
    }
    .line{
      font: 700 28px/1.35 var(--mono);
      letter-spacing:.3px;
      text-shadow: var(--halo);
      opacity:0;
      transition:opacity 1s ease;
      white-space:pre-wrap;
    }
    .line.show{ opacity:1; }

    .cursor{
      display:inline-block;
      width:.6ch;
      margin-left:2px;
      animation: blink 1s steps(1,end) infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    .final{
      opacity:0;
      transition:opacity 1s ease;
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top:24px;
    }
    .final.show{ opacity:1; }
    .final img{
      max-width: min(78vw, 780px);
      height:auto;
      filter: drop-shadow(0 0 24px rgba(70,140,255,.35));
    }

    /* un peu plus petit si tu veux */
    @media (max-width:640px){
      .line{ font-size:22px; }
    }

    /* Accessibilité : si l’utilisateur réduit les animations, on réduit la durée */
    @media (prefers-reduced-motion: reduce){
      .line, .final{ transition:none; }
    }
  </style>
</head>
<body>
  <main class="stage">
    <section class="block">
      <div id="l1" class="line"></div>
      <div id="l2" class="line" style="margin-top:18px;"></div>

      <div id="final" class="final" aria-hidden="true">
        <!-- remplace l’image si besoin -->
        <img src="{{ url_for('static', filename='img/weather_bets_intro.png') }}" alt="Transition">
      </div>
    </section>
  </main>

  <script>
  (function(){
    const USERNAME = {{ (current_user.username|tojson) if current_user.is_authenticated else "'explorateur'" }};
    const L1 = `Bienvenue dans les cieux ${USERNAME}`;
    const L2 = `Dans un monde où tout devient prévisible, il reste…`;

    const line1 = document.getElementById('l1');
    const line2 = document.getElementById('l2');
    const final = document.getElementById('final');

    const TYPE_MS = 18;          // vitesse frappe
    const SHOW_MS = 4000;        // temps affiché plein
    const FADE_MS = 1000;        // fondu in/out

    function typeInto(el, text){
      return new Promise(resolve=>{
        el.textContent = '';
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        cursor.textContent = '▍';
        el.appendChild(cursor);

        let i = 0;
        function tick(){
          if (i < text.length){
            cursor.insertAdjacentText('beforebegin', text[i++]);
            setTimeout(tick, TYPE_MS);
          } else {
            resolve();
          }
        }
        tick();
      });
    }

    function fadeIn(el){ el.classList.add('show'); return new Promise(r=>setTimeout(r, FADE_MS)); }
    function fadeOut(el){ el.classList.remove('show'); return new Promise(r=>setTimeout(r, FADE_MS)); }

    async function run(){
      // 1) Ligne 1
      await fadeIn(line1);
      await typeInto(line1, L1);
      await new Promise(r=>setTimeout(r, SHOW_MS));
      await fadeOut(line1);

      // 2) Ligne 2
      await fadeIn(line2);
      await typeInto(line2, L2);
      await new Promise(r=>setTimeout(r, SHOW_MS));
      await fadeOut(line2);

      // 3) Image finale
      await fadeIn(final);
      await new Promise(r=>setTimeout(r, 4000));
      await fadeOut(final);

      // 4) Redirection Cabine
      window.location.assign('{{ url_for("cabine_page") }}');
    }

    // si animations réduites, on raccourcit le scénario
    const prefersReduced = window.matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReduced){
      // montrer brièvement puis rediriger
      line1.textContent = L1;
      line1.classList.add('show');
      setTimeout(()=> window.location.assign('{{ url_for("cabine_page") }}'), 1000);
    } else {
      run();
    }
  })();
  </script>
</body>
</html>